# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  Tela_Anexos:
    Properties:
      LoadingSpinnerColor: =RGBA(56, 96, 178, 1)
      OnVisible: |-
        =If(
            !IsBlank(ItemAtual),
            ResetForm(Form_Anexo);
            EditForm(Form_Anexo);
            /*Set(
                ItemAtual;
                LookUp(
                    SAVe_Forms_Demo;
                    ID = ItemAtual.ID
                )
            );;*/
            ClearCollect(
                Anexos_Info,
                ForAll(
                    Table(ParseJSON(ItemAtual.Anexos_Info)),
                    {
                        NomeArquivoUser: Text(ThisRecord.Value.NomeArquivoUser),
                        EmailUser: Text(ThisRecord.Value.EmailUser),
                        DataUser: DateTimeValue(ThisRecord.Value.DataUser),
                        Tela: Text(ThisRecord.Value.Tela)
                    }
                )
            ),
            ResetForm(Form_Anexo);
            NewForm(Form_Anexo)
        )
    Children:
      - Container12:
          Control: GroupContainer@1.3.0
          Variant: AutoLayout
          Properties:
            Height: =Parent.Height
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =10
            PaddingBottom: =10
            PaddingLeft: =10
            PaddingRight: =10
            PaddingTop: =10
            Width: =Parent.Width
          Children:
            - TituloTelaAnexos:
                Control: Text@0.0.51
                Properties:
                  Align: ='TextCanvas.Align'.Center
                  AlignInContainer: =AlignInContainer.Stretch
                  BorderRadius: =10
                  Fill: =ColorFade(cor.tema, 40%)
                  FontColor: =RGBA(255, 255, 255, 1)
                  Height: =80
                  Size: =30
                  Text: ="Anexos"
                  VerticalAlign: =VerticalAlign.Middle
                  Weight: ='TextCanvas.Weight'.Bold
                  Width: =Parent.Width - 40
            - ContainerFundoGalAnexos:
                Control: GroupContainer@1.3.0
                Variant: AutoLayout
                Properties:
                  Fill: =ColorFade(cor.tema, 40%)
                  LayoutDirection: =LayoutDirection.Horizontal
                  PaddingBottom: =10
                  PaddingLeft: =10
                  PaddingRight: =10
                  PaddingTop: =10
                  RadiusBottomLeft: =10
                  RadiusBottomRight: =10
                  RadiusTopLeft: =10
                  RadiusTopRight: =10
                Children:
                  - GalAnexos:
                      Control: Gallery@2.15.0
                      Variant: BrowseLayout_Vertical_TwoTextOneImageVariant_ver5.0
                      Properties:
                        BorderColor: =RGBA(0, 18, 107, 1)
                        FillPortions: =0.5
                        Items: |-
                          =Filter(ForAll(
                              ParseJSON(ItemAtual.Anexos_Info),
                              {
                                  DataUser: DateTimeValue(ThisRecord.DataUser),
                                  EmailUser: Text(ThisRecord.EmailUser),
                                  NomeArquivoUser: Text(ThisRecord.NomeArquivoUser),
                                  Tela: Text(ThisRecord.Tela)
                              }
                          ),
                          Tela = _telaAnexo.Name
                          )
                      Children:
                        - ContainerFundoTemplateAnexo_1:
                            Control: GroupContainer@1.3.0
                            Variant: ManualLayout
                            Properties:
                              Fill: =RGBA(255, 255, 255, 1)
                              Height: =Parent.TemplateHeight - 10
                              RadiusBottomLeft: =10
                              RadiusBottomRight: =10
                              RadiusTopLeft: =10
                              RadiusTopRight: =10
                              Width: =Parent.TemplateWidth - 40
                              X: =20
                              Y: =10
                            Children:
                              - NomeAnexo_1:
                                  Control: Label@2.5.1
                                  Properties:
                                    Align: =Align.Center
                                    BorderColor: =RGBA(0, 0, 0, 1)
                                    Color: =RGBA(50, 49, 48, 1)
                                    Font: =Font.Lato
                                    FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
                                    Height: =Self.Size * 1.8
                                    PaddingBottom: =0
                                    PaddingLeft: =0
                                    PaddingRight: =0
                                    PaddingTop: =0
                                    Size: =16
                                    Text: =ThisItem.NomeArquivoUser
                                    VerticalAlign: =VerticalAlign.Top
                                    Width: =GalAnexos.TemplateWidth - 50
                                    X: =5
                                    Y: =5
                              - UsuarioAnexo_1:
                                  Control: Label@2.5.1
                                  Properties:
                                    Align: =Align.Center
                                    BorderColor: =RGBA(0, 0, 0, 1)
                                    Font: =Font.Lato
                                    FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
                                    Height: =Self.Size * 1.8
                                    PaddingBottom: =0
                                    PaddingLeft: =0
                                    PaddingRight: =0
                                    PaddingTop: =0
                                    Size: =14
                                    Text: =UsuáriosdoOffice365.UserProfileV2(ThisItem.EmailUser).displayName
                                    VerticalAlign: =VerticalAlign.Top
                                    Width: =NomeAnexo_1.Width
                                    X: =NomeAnexo_1.X
                                    Y: =NomeAnexo_1.Y + NomeAnexo_1.Height
                              - DataAnexo_1:
                                  Control: Label@2.5.1
                                  Properties:
                                    Align: =Align.Center
                                    BorderColor: =RGBA(0, 0, 0, 1)
                                    Font: =Font.Lato
                                    FontWeight: =If(ThisItem.IsSelected, FontWeight.Semibold, FontWeight.Normal)
                                    Height: =Self.Size * 1.8
                                    PaddingBottom: =0
                                    PaddingLeft: =0
                                    PaddingRight: =0
                                    PaddingTop: =0
                                    Size: =14
                                    Text: =ThisItem.DataUser
                                    VerticalAlign: =VerticalAlign.Top
                                    Width: =NomeAnexo_1.Width
                                    X: =NomeAnexo_1.X
                                    Y: =UsuarioAnexo_1.Y + UsuarioAnexo_1.Height
                              - CheckboxCanvas2:
                                  Control: CheckBox@0.0.30
                                  Properties:
                                    Checked: =ThisItem.IsSelected
                                    Height: =40
                                    Label: =
                                    Width: =40
                                    X: =20
                                    Y: =UsuarioAnexo_1.Y - Self.Height/5
                        - ButtonCanvas12:
                            Control: Button@0.0.45
                            Properties:
                              Appearance: ='ButtonCanvas.Appearance'.Transparent
                              Height: =Parent.TemplateHeight
                              Layout: ='ButtonCanvas.Layout'.IconOnly
                              OnSelect: |-
                                =Select(Parent);
                                //ClearCollect(ArquivosSelecionados;{Nome:ThisItem.NomeArquivoUser});;
                                Set(OcultaPDF,true)
                              Text: =
                              Width: =Parent.TemplateWidth
                  - VisualizadorImagemAnexo:
                      Control: Image@2.2.3
                      Properties:
                        AlignInContainer: =AlignInContainer.Stretch
                        BorderColor: =RGBA(0, 18, 107, 1)
                        Fill: =RGBA(255, 255, 255, 1)
                        FillPortions: =1
                        Height: =Parent.Height
                        Image: |-
                          =If(
                              !IsBlank(
                                  If(
                                      !EndsWith(
                                          GalAnexos.Selected.NomeArquivoUser,
                                          ".pdf"
                                      ) && !EndsWith(
                                          GalAnexos.Selected.NomeArquivoUser,
                                          ".mkv"
                                      ) && !EndsWith(
                                          GalAnexos.Selected.NomeArquivoUser,
                                          ".mp4"
                                      ),
                                      LookUp(
                                          ItemAtual.Anexos,
                                          GalAnexos.Selected.NomeArquivoUser = ThisRecord.DisplayName
                                      ).AbsoluteUri
                                  )
                              ),
                              If(
                                  !EndsWith(
                                      GalAnexos.Selected.NomeArquivoUser,
                                      ".pdf"
                                  ) && !EndsWith(
                                      GalAnexos.Selected.NomeArquivoUser,
                                      ".mkv"
                                  ) && !EndsWith(
                                      GalAnexos.Selected.NomeArquivoUser,
                                      ".mp4"
                                  ),
                                  LookUp(
                                      ItemAtual.Anexos,
                                      GalAnexos.Selected.NomeArquivoUser = ThisRecord.DisplayName
                                  ).AbsoluteUri
                              ),
                              Carregando
                          )
                        Visible: =!IsBlank(GalAnexos.Selected) && !IsEmpty(GalAnexos.AllItems)
            - ContainerAnexos_12:
                Control: GroupContainer@1.3.0
                Variant: ManualLayout
                Properties:
                  BorderColor: =RGBA(217, 217, 217, 1)
                  BorderThickness: =2
                  DropShadow: =DropShadow.Regular
                  Fill: =ColorFade(cor.tema, 40%)
                  FillPortions: =0.4
                  RadiusBottomLeft: =8
                  RadiusBottomRight: =8
                  RadiusTopLeft: =8
                  RadiusTopRight: =8
                  Width: =Parent.Width - 33
                  X: =10
                  Y: =5
                Children:
                  - TituloAnexos_12:
                      Control: Text@0.0.51
                      Properties:
                        Align: ='TextCanvas.Align'.Center
                        Font: =Font.Lato
                        FontColor: =RGBA(255, 255, 255, 1)
                        Height: =60
                        Size: =28
                        Text: ="Editor de Arquivos Anexados"
                        VerticalAlign: =VerticalAlign.Middle
                        Weight: ='TextCanvas.Weight'.Semibold
                        Width: =500
                        X: =Parent.Width/2 - Self.Width/2
                  - Form_Anexo:
                      Control: Form@2.4.4
                      Variant: Classic
                      Layout: Vertical
                      Properties:
                        BorderColor: =RGBA(0, 0, 0, 1)
                        DataSource: =SAVe_Geral
                        DefaultMode: =If(ItemAtual.Encerrado, FormMode.View, FormMode.Edit)
                        Height: =131
                        Item: =LookUp(SAVe_Geral, ID_Caso = ItemAtual.ID_Caso)
                        Width: =613
                        X: =Parent.Width/2 - Self.Width/2
                        Y: =54
                      Children:
                        - Anexos_DataCard1_1:
                            Control: TypedDataCard@1.0.7
                            Variant: ClassicAttachmentsEdit
                            Properties:
                              BorderColor: =RGBA(0, 18, 107, 1)
                              DataField: ="{Attachments}"
                              Default: |-
                                =Filter(
                                    ThisItem.Anexos,
                                    LookUp(
                                        Filter(
                                            ForAll(
                                                ParseJSON(ItemAtual.Anexos_Info),
                                                {
                                                    DataUser: DateTimeValue(ThisRecord.DataUser),
                                                    EmailUser: Text(ThisRecord.EmailUser),
                                                    NomeArquivoUser: Text(ThisRecord.NomeArquivoUser),
                                                    Tela: Text(ThisRecord.Tela)
                                                }
                                            ),
                                            Tela = _telaAnexo.Name
                                        ),
                                        NomeArquivoUser = DisplayName
                                    ).NomeArquivoUser = DisplayName
                                )
                              DisplayName: =DataSourceInfo([@SAVe_Geral],DataSourceInfo.DisplayName,Anexos)
                              Height: =Parent.Height
                              Required: =false
                              Update: =InputAnexos_11.Attachments
                              Width: =Parent.Width
                              X: =0
                              Y: =0
                            Children:
                              - Container2_12:
                                  Control: GroupContainer@1.3.0
                                  Variant: ManualLayout
                                  Properties:
                                    BorderColor: =RGBA(255, 255, 255, 1)
                                    BorderThickness: =1
                                    DropShadow: =DropShadow.None
                                    Fill: =RGBA(255, 255, 255, 1)
                                    Height: =100
                                    RadiusBottomLeft: =20
                                    RadiusBottomRight: =20
                                    RadiusTopLeft: =20
                                    RadiusTopRight: =20
                                    Width: =523
                                    X: =40
                                    Y: =12
                              - ErrorMessage1_1:
                                  Control: Label@2.5.1
                                  MetadataKey: ErrorMessage
                                  Properties:
                                    AutoHeight: =true
                                    BorderColor: =RGBA(0, 0, 0, 1)
                                    Color: =RGBA(168, 0, 0, 1)
                                    Font: =Font.'Open Sans'
                                    FontWeight: =FontWeight.Semibold
                                    Height: =10
                                    Live: =Live.Assertive
                                    PaddingBottom: =0
                                    PaddingLeft: =0
                                    PaddingRight: =0
                                    PaddingTop: =0
                                    Size: =14
                                    Text: =Parent.Error
                                    Visible: =Parent.DisplayMode=DisplayMode.Edit
                                    Width: =InputAnexos_11.Width
                                    X: =30
                                    Y: =InputAnexos_11.Y + InputAnexos_11.Height
                              - InputAnexos_11:
                                  Control: Attachments@2.3.0
                                  MetadataKey: FieldValue
                                  Properties:
                                    BorderColor: =If(IsBlank(Parent.Error), Parent.BorderColor, Color.Red)
                                    DisplayMode: =Parent.DisplayMode
                                    Font: =Font.'Open Sans'
                                    Height: =100
                                    HoverFill: =RGBA(186, 202, 226, 1)
                                    ItemColor: =RGBA(255, 255, 255, 1)
                                    ItemFill: =RGBA(56, 96, 178, 1)
                                    ItemHoverFill: =RGBA(186, 202, 226, 1)
                                    Items: =Parent.Default
                                    PaddingBottom: =5
                                    PaddingLeft: =If(Self.DisplayMode = DisplayMode.Edit, 5, 0)
                                    PaddingRight: =5
                                    PaddingTop: =5
                                    PressedColor: =RGBA(255, 255, 255, 1)
                                    PressedFill: =RGBA(0, 18, 107, 1)
                                    Tooltip: =Parent.DisplayName
                                    Width: =523
                                    X: =40
                                    Y: =12
                  - BotaoSalvarAnexo:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ='ButtonCanvas.Appearance'.Primary
                        BasePaletteColor: =cor.tema
                        BorderRadius: =10
                        DisplayMode: =If(ItemAtual.Encerrado, DisplayMode.Disabled, DisplayMode.Edit)
                        Icon: ="Save"
                        OnSelect: |-
                          =ForAll(
                              InputAnexos_11.Attachments As Input,
                              If(
                                  IsEmpty(
                                      Filter(
                                          Anexos_Info,
                                          NomeArquivoUser = Input.Name && Tela = _telaAnexo.Name
                                      )
                                  ),
                                  Collect(
                                      Anexos_Info,
                                      {
                                          NomeArquivoUser: Text(Input.Name),
                                          EmailUser: User().Email,
                                          DataUser: Now(),
                                          Tela: _telaAnexo.Name
                                      }
                                  )
                              )
                          );
                          ForAll(
                              Anexos_Info,
                              RemoveIf(
                                  Anexos_Info As Info,
                                  IsBlank(
                                      LookUp(
                                          InputAnexos_11.Attachments,
                                          Name = Info.NomeArquivoUser
                                      )
                                  ) && Info.Tela = _telaAnexo.Name
                              )
                          );

                          If(
                              IsBlankOrError(ItemAtual),
                              Set(
                                  ItemAtual,
                                  Patch(
                                      SAVe_Geral,
                                      Defaults(SAVe_Geral),
                                      {Anexos_Info: JSON(Anexos_Info)},
                                      Form_Anexo.Updates
                                  )
                              ),
                              Set(
                                  ItemAtual,
                                  Patch(
                                      SAVe_Geral,
                                      LookUp(SAVe_Geral, ID_Caso = ItemAtual.ID_Caso),
                                      {Anexos_Info: JSON(Anexos_Info)},
                                      Form_Anexo.Updates
                                  )
                              )
                          );
                          ResetForm(Form_Anexo);
                          EditForm(Form_Anexo)
                        Text: ="Salvar"
                        Width: =200
                        X: =1051
                        Y: =103
                  - BotaoVoltarAnexo:
                      Control: Button@0.0.45
                      Properties:
                        Appearance: ='ButtonCanvas.Appearance'.Primary
                        BasePaletteColor: =cor.tema
                        BorderRadius: =10
                        Icon: ="ArrowLeft"
                        OnSelect: =Back()
                        Text: ="Voltar"
                        Width: =200
                        X: =41
                        Y: =103
      - Image2:
          Control: Image@2.2.3
          Properties:
            BorderColor: =RGBA(0, 18, 107, 1)
            Fill: =RGBA(255, 255, 255, 1)
            Height: =Parent.Height - 20
            Image: =VisualizadorImagemAnexo.Image
            Visible: =_expandirItem
            Width: =Parent.Width - 20
            X: =10
            Y: =10
      - VIsualizadorPDFAnexo:
          Control: PDFViewer@2.5.0
          Properties:
            Document: =If(EndsWith(GalAnexos.Selected.NomeArquivoUser,".pdf"),LookUp(ItemAtual.Anexos,GalAnexos.Selected.NomeArquivoUser = ThisRecord.DisplayName).Value)
            Fill: =RGBA(255, 250, 250, 1)
            Height: =If(!_expandirItem, VisualizadorImagemAnexo.Height, Parent.Height - 20)
            Visible: =!IsBlank(GalAnexos.Selected) && EndsWith(GalAnexos.Selected.NomeArquivoUser,".pdf")
            Width: =If(!_expandirItem, VisualizadorImagemAnexo.Width, Parent.Width - 20)
            X: =If(!_expandirItem, VisualizadorImagemAnexo.X + ContainerFundoGalAnexos.PaddingLeft, 10)
            Y: =If(!_expandirItem, ContainerFundoGalAnexos.Y + ContainerFundoGalAnexos.PaddingTop, 10)
      - ContainerNaoLeWord:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            Height: =VIsualizadorPDFAnexo.Height
            Visible: =If(EndsWith(GalAnexos.Selected.NomeArquivoUser,".docx") || EndsWith(GalAnexos.Selected.NomeArquivoUser,".doc") || EndsWith(GalAnexos.Selected.NomeArquivoUser,".html") || EndsWith(GalAnexos.Selected.NomeArquivoUser,".txt") || EndsWith(GalAnexos.Selected.NomeArquivoUser,".odt"),true,false)
            Width: =VIsualizadorPDFAnexo.Width
            X: =VIsualizadorPDFAnexo.X
            Y: =VIsualizadorPDFAnexo.Y
          Children:
            - Label1_7:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  BorderColor: =RGBA(0, 18, 107, 1)
                  Font: =Font.Georgia
                  Height: =172
                  Size: =30
                  Text: ="Não é possível exibir o conteúdo deste arquivo."
                  Width: =732
                  X: =Parent.Width/2 - Self.Width/2
                  Y: =Label1_8.Height + 5
            - Label1_8:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  BorderColor: =RGBA(0, 18, 107, 1)
                  Font: =Font.Georgia
                  Height: =112
                  Size: =30
                  Text: ="Ooops! Desculpe!"
                  Width: =732
                  X: =Parent.Width/2 - Self.Width/2
                  Y: =10
            - Label1_9:
                Control: Label@2.5.1
                Properties:
                  Align: =Align.Center
                  BorderColor: =RGBA(0, 18, 107, 1)
                  Font: =Font.Georgia
                  Height: =72
                  Size: =18
                  Text: ="Para visualizá-lo é necessário fazer o download para o seu dispositivo."
                  Width: =732
                  X: =Parent.Width/2 - Self.Width/2
                  Y: =Label1_7.Height + Label1_7.Y + 10
      - BotaoDownloadAnexo:
          Control: Button@0.0.45
          Properties:
            Appearance: ='ButtonCanvas.Appearance'.Transparent
            BasePaletteColor: =cor.tema
            BorderRadius: =10
            Height: =40
            Icon: ="ArrowDownload"
            IconStyle: ='ButtonCanvas.IconStyle'.Filled
            Layout: ='ButtonCanvas.Layout'.IconOnly
            OnSelect: |-
              =Download(
                  LookUp(
                      ItemAtual.Anexos,
                      GalAnexos.Selected.NomeArquivoUser = ThisRecord.DisplayName
                  ).AbsoluteUri
              )
            Text: ="Download"
            Visible: =!IsBlank(GalAnexos.Selected) && !IsEmpty(GalAnexos.AllItems)
            Width: =40
            X: =If(!_expandirItem, Icon1.X + 760, Icon1.X + 1200)
            Y: =Icon1.Y - Self.Height/4
      - Icon1:
          Control: Classic/Icon@2.5.0
          Properties:
            BorderColor: =RGBA(0, 18, 107, 1)
            Color: =cor.tema
            Height: =25
            Icon: =If(_expandirItem, Icon.CollapseView, Icon.ExpandView)
            OnSelect: =Set(_expandirItem, !_expandirItem)
            Visible: =!IsBlank(GalAnexos.Selected)  && !IsEmpty(GalAnexos.AllItems)
            Width: =25
            X: =VIsualizadorPDFAnexo.X + 50
            Y: =VIsualizadorPDFAnexo.Y + 20
