# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
Screens:
  Tela_Relatorio:
    Properties:
      LoadingSpinnerColor: =RGBA(56, 96, 178, 1)
    Children:
      - Container23:
          Control: GroupContainer@1.3.0
          Variant: ManualLayout
          Properties:
            Fill: |+
              =With(
                      {
                          loc_RGBAColor: If(App.ActiveScreen = MenuPassos_19.TelaAtual,cor.tema,Color.Transparent),
                          loc_AlphaValue: 70
                      },
                      ColorValue(
                          Concatenate(
                              Left(
                                  Substitute(
                                      JSON(loc_RGBAColor),
                                      """",
                                      ""
                                  ),
                                  7
                              ),
                              Dec2Hex(
                                  Round(
                                      loc_AlphaValue / 100 * 255,
                                      0
                                  )
                              )
                          )
                      )
                  )

            Height: =Container22.Height + 20
            Width: =Parent.Width
            Y: =MenuPassos_19.Y + MenuPassos_19.Height - 10
      - Container22:
          Control: GroupContainer@1.3.0
          Variant: AutoLayout
          Properties:
            DropShadow: =DropShadow.Semilight
            Fill: =ColorFade(cor.tema,83%)
            Height: =583
            LayoutAlignItems: =LayoutAlignItems.Center
            LayoutDirection: =LayoutDirection.Vertical
            LayoutGap: =20
            PaddingBottom: =5
            PaddingLeft: =5
            PaddingRight: =5
            PaddingTop: =10
            RadiusBottomLeft: =8
            RadiusBottomRight: =8
            RadiusTopLeft: =8
            RadiusTopRight: =8
            Width: =Parent.Width - 20
            X: =10
            Y: =MenuPassos_19.Y + MenuPassos_19.Height
          Children:
            - TituloGerarRelatorio:
                Control: Text@0.0.51
                Properties:
                  Align: ='TextCanvas.Align'.Center
                  Font: =Font.Lato
                  FontColor: =cor.tema
                  Height: =50
                  Size: =20
                  Text: ="Escolha os dados que serão emitidas no relatório:"
                  VerticalAlign: =VerticalAlign.Middle
                  Weight: ='TextCanvas.Weight'.Semibold
                  Width: =450
            - SeletorDadosGerarRelatorio:
                Control: ComboBox@0.0.51
                Properties:
                  Appearance: ='ComboboxCanvas.Appearance'.FilledLighter
                  DefaultSelectedItems: =Blank()
                  InputTextPlaceholder: ="Escolha os dados..."
                  Items: |+
                    =Filter(MenuPassos_1.GaleriaAbas, nome <> "Matriz de risco" && nome <> "Síntese Analítica" && nome <> "Documentação")
                    /*AddColumns(
                        Filter(
                            MenuPassos_1.GaleriaAbas;
                            nome <> "Matriz de risco" &&
                            nome <> "Síntese Analítica" &&
                            nome <> "Documentação"
                        );
                        nome_exibir;
                        If(
                            nome = "Acompanhamentos";
                            "Encaminhamento Externo";
                            nome
                        )
                    )*/
                  OnChange: |-
                    =ClearCollect(_telasSelecionadas, Self.SelectedItems)
                    /*ClearCollect(
                        _telasSelecionadas;
                        AddColumns(
                            Self.SelectedItems;
                            'nome_corrigido';
                            If(
                                nome = "Acompanhamentos";
                                "Encaminhamento Externo";
                                nome
                            )
                        )
                    )
                    */
                  SelectMultiple: =true
                  X: =248
                  Y: =428
                Children:
                  - nome2:
                      Control: ComboBoxDataField@1.5.0
                      Variant: textualColumn
                      IsLocked: true
                      Properties:
                        FieldDisplayName: ="nome"
                        FieldName: |-
                          ="nome"
                          //"nome_exibir"
                        FieldType: ="s"
                        Order: =1
            - botaoGerarPDF:
                Control: Button@0.0.45
                Properties:
                  Appearance: ='ButtonCanvas.Appearance'.Primary
                  BasePaletteColor: =cor.tema
                  BorderRadius: =8
                  BorderThickness: =0
                  IconStyle: ='ButtonCanvas.IconStyle'.Filled
                  OnSelect: "=Set(_Carregando, true);\n\n// Atualiza o idMenu de Encerramento para um número alto, coleções usadas para sempre mostrar os dados de Encerramento por ultimo\nPatch(\n    _telasSelecionadas,\n    LookUp(_telasSelecionadas, nome = \"Encerramento\"),\n    { idMenu: CountRows(_telasSelecionadas) + 1 }\n);\n// Cria uma nova coleção ordenada pela coluna idMenu\nClearCollect(\n    telasOrdenadas,\n    Sort(_telasSelecionadas, idMenu, \"Ascending\")\n);\n\n// A função 'With' busca todos os registros necessários apenas uma vez e os armazena em variáveis.\n// Isso evita centenas de chamadas repetidas ao SharePoint, melhorando drasticamente a performance.\nWith(\n    {\n        // -- Registros de Listas Principais\n        dadosEntrada: LookUp(SAVe_DadosDeEntrada, ID_Caso = ItemAtual.ID_Caso),\n        dadosIdentificacao: LookUp(SAVe_Identificacao, ID_Caso = ItemAtual.ID_Caso),\n        dadosEnsino: LookUp('SAVe_Ensino-trab-renda', ID_Caso = ItemAtual.ID_Caso),\n        dadosAssistencia: LookUp(SAVe_Assistencia, ID_Caso = ItemAtual.ID_Caso),\n        dadosHabitacao: LookUp(SAVe_Habitacao_territorio, ID_Caso = ItemAtual.ID_Caso),\n        dadosSaude: LookUp(SAVe_Saude, ID_Caso = ItemAtual.ID_Caso),\n        dadosVinculos: LookUp(SAVe_Vinculos, ID_Caso = ItemAtual.ID_Caso),\n        dadosJuridico1: LookUp(SAVe_Situacao_Juridica, ID_Caso = ItemAtual.ID_Caso),\n        dadosJuridico2: LookUp(SAVe_Situacao_Juridica2, ID_Caso = ItemAtual.ID_Caso),\n        dadosProtecao: LookUp(SAVe_protecao_seguranca, ID_Caso = ItemAtual.ID_Caso),\n        dadosVitimizacao: LookUp(SAVe_Vitimizacao, ID_Caso = ItemAtual.ID_Caso),\n        dadosCasosVinculados: LookUp(SAVe_Casos_Vinculados, ID_Caso = ItemAtual.ID_Caso),\n        //dadosAcompanhamentos: LookUp(SAVe_Acompanhamentos; ID_Caso = ItemAtual.ID_Caso);\n        dadosEncerramento: LookUp(SAVe_Encerramento, ID_Caso = ItemAtual.ID_Caso),\n\n        // -- Tabelas de Listas Relacionadas (Múltiplos registros por caso) --\n        listaEnderecos: Filter(SAVe_Identificacao_endereco, ID_Caso = ItemAtual.ID_Caso),\n        listaTelefones: Filter(SAVe_Identificacao_telefone, ID_Caso = ItemAtual.ID_Caso),\n        listaEmails: Filter(SAVe_Identificacao_email, ID_Caso = ItemAtual.ID_Caso),\n        listaFamiliares: Filter(SAVe_Vinculos_Apoio, ID_Caso = ItemAtual.ID_Caso),\n        agressoresComEnderecos: AddColumns(\n            Filter(SAVe_Perfil_Agressor, ID_Caso = ItemAtual.ID_Caso),\n            enderecosAgressor,\n            Filter(\n                SAVe_Perfil_Agressor_Endereco,\n                ID_Caso = ItemAtual.ID_Caso //&& ID_Perfil_Agressor = ThisRecord.ID\n            )\n        ),\n\n        listaAmeacadores: Filter(SAVe_protecao_seguranca_ameacadores, ID_Caso = ItemAtual.ID_Caso),\n        listaAdolescentesAmeacados: Filter(SAVe_protecao_seguranca_adolescente, ID_Caso = ItemAtual.ID_Caso),\n        listaAcompanhamentos: Filter(SAVe_Acompanhamentos, ID_Caso = ItemAtual.ID_Caso)\n    },\n\n    // --- ETAPA 2: MONTAR O HTML ---\n    ClearCollect(\n        htmlParts,\n        {\n            part: \"<!DOCTYPE html><html lang='pt-BR'><head><meta charset='UTF-8'><title>Relatório PAV CasaLilian</title><style>\n                body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; color: #343a40; line-height: 1.5; }\n                @page { margin: 25mm 20mm 25mm 20mm; }\n                h1, h2, h3, h4 { color: #3860B2; page-break-after: avoid; }\n                h1 { text-align: center; margin-bottom: 25px; font-size: 1.8em; }\n                h2 { border-bottom: 2px solid #3860B2; padding-bottom: 8px; margin-top: 0; margin-bottom: 20px; text-align: center; font-size: 1.5em; }\n                h3 { color: #495057; border-bottom: 1px dashed #ced4da; padding-bottom: 5px; font-size: 1.2em; margin-top: 25px; }\n                h4 { color: #495057; font-size: 1.1em; margin-top: 20px;}\n                p, li { font-size: 11pt; margin-bottom: 8px; page-break-inside: avoid; }\n                strong { font-weight: 600; }\n                .section { page-break-before: always; padding: 20px; }\n                .section:first-of-type { page-break-before: avoid; }\n                .content-box, .sub-section, .agressor-item, .acompanhamento-item { background-color: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 10px; border: 1px solid #dee2e6; page-break-inside: avoid; }\n                .text-block { background-color: #ffffff; border: 1px solid #e9ecef; padding: 10px; border-radius: 5px; margin-top: 5px; white-space: pre-wrap; page-break-inside: avoid; }\n                table.report-table, table.report-table-inner { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 10pt; }\n                table.report-table th, table.report-table td, table.report-table-inner th, table.report-table-inner td { border: 1px solid #dee2e6; padding: 8px; text-align: left; vertical-align: top; page-break-inside: avoid; }\n                table.report-table th { background-color: #e9ecef; }\n                ul { padding-left: 25px; margin-top: 5px; margin-bottom: 10px;}\n            </style></head><body><h1>Relatório PAV/SAVe - Caso \" & ItemAtual.ID_Caso & \"</h1>\"\n        }\n    );\n\n    ForAll(\n        //_telasSelecionadas;\n        telasOrdenadas,\n        With({tela: ThisRecord.nome},\n            Collect(htmlParts,\n                Switch(tela,\n                    // --- SEÇÃO: DADOS DE ENTRADA ---\n                    \"Dados de Entrada\", { part: \n                        \"<div class='section'>\n                            <h2>Dados de Entrada</h2>\n                            <div class='content-box'>\n                                <p><strong>Data de Entrada:</strong> \" & Coalesce(Text(dadosEntrada.Data, \"dd/mm/yyyy\"), \"Não informado\") & \"</p>\n                                <p><strong>Município de Origem:</strong> \" & Coalesce(dadosEntrada.Comarca_origem, \"Não informado\") & \"</p>\n                                <p><strong>Precisa de atendimento especial?:</strong> \" & Coalesce(dadosEntrada.Precisa_Atendimento_Esp, \"Não informado\") & \"</p>\n                                \" & If(dadosEntrada.Precisa_Atendimento_Esp = \"Sim\", \"<p><strong>Qual tipo?:</strong> \" & Coalesce(PlainText(dadosEntrada.Atendimento_Especial), \"Não informado\") & \"</p>\", \"\") & \"\n                            </div>\n                            <div class='content-box'>\n                                <h3>Crimes ou Atos Infracionais Relacionados</h3>\n                                \" & If(IsEmpty([{Value:dadosEntrada.Crime_relacionado}]), \"<p>Nenhum crime informado.</p>\", \"<ul>\" & Concat(Split(dadosEntrada.Crime_relacionado, \";\"), \"<li>\" & Value & \"</li>\") & \"</ul>\") & \"\n                            </div>\n                        </div>\"\n                    },\n\n                    // --- SEÇÃO: SÓCIO IDENTIFICAÇÃO ---\n                    \"Sócio identificação\", \n                    { part:\n                        \"<div class='section'>\n                            <h2>Sócio Identificação</h2>\n                            <div class='content-box'>\n                                <h3>Dados Civis</h3>\n                                <p><strong>Nome (Registro Civil):</strong> \" & Coalesce(PlainText(dadosIdentificacao.Nome_RC), \"Não informado\") & \"</p>\n                                <p><strong>Nome Social:</strong> \" & Coalesce(PlainText(dadosIdentificacao.Nome_social_ancestral), \"Não informado\") & \"</p>\n                                <p><strong>Data de Nascimento:</strong> \" & Coalesce(Text(dadosIdentificacao.Data_nascimento, \"dd/mm/yyyy\"), \"Não informada\") & \"</p>\n                                <p><strong>Idade:</strong> \" & If(!IsBlank(dadosIdentificacao.Data_nascimento), Text(DateDiff(DateValue(dadosIdentificacao.Data_nascimento),Today(),TimeUnit.Years)) & \" anos\", \"Não informada\") & \"</p>\n                            </div>\n                            <div class='content-box'>\n                                <h3>Endereço(s)</h3>\n                                \" & If(IsEmpty(listaEnderecos), \"<p>Nenhum endereço cadastrado.</p>\", Concat(listaEnderecos, \"<div class='sub-section'><p><strong>Endereço:</strong> \" & PlainText(Endereco) & \", \" & Coalesce(Numero, \"S/N\") & \"</p><p><strong>Cidade/UF:</strong> \" & PlainText(Cidade) & \"/\" & UF & \"</p></div>\")) & \"\n                            </div>\n                            <div class='content-box'>\n                                <h3>Contatos</h3>\n                                \" & If(IsEmpty(listaTelefones), \"<p>Nenhum telefone cadastrado.</p>\", \"<h4>Telefones:</h4><ul>\" & Concat(listaTelefones, \"<li>\" & TelefoneDDD & \"</li>\") & \"</ul>\") & \"\n                                \" & If(IsEmpty(listaEmails), \"<p>Nenhum e-mail cadastrado.</p>\", \"<h4>E-mails:</h4><ul>\" & Concat(listaEmails, \"<li>\" & 'E-mail' & \"</li>\") & \"</ul>\") & \"\n                            </div>\n                        </div>\"\n                    },\n                    \n                    // --- SEÇÃO: ENSINO, TRABALHO E RENDA ---\n                    \"Ensino - trab - renda\", { part:\n                         \"<div class='section'>\n                            <h2>Ensino, Trabalho e Renda</h2>\n                            <div class='content-box'>\n                                <h3>Vida Escolar/Acadêmica</h3>\n                                <p><strong>Grau de escolaridade:</strong> \" & Coalesce(dadosEnsino.Grau_escolaridade, \"Não informado\") & \"</p>\n                                <p><strong>Estuda atualmente?:</strong> \" & Coalesce(dadosEnsino.Estuda_atualmente, \"Não informado\") & \"</p>\n                                \" & If(dadosEnsino.Estuda_atualmente = \"Sim\", \"<p><strong>Nome da instituição:</strong> \" & Coalesce(PlainText(dadosEnsino.Nome_instituicao), \"Não informado\") & \"</p>\", \"\") & \"\n                            </div>\n                             <div class='content-box'>\n                                <h3>Trabalho e Renda</h3>\n                                <p><strong>Situação ocupacional de trabalho:</strong> \" & Coalesce(dadosEnsino.Situacao_trabalho, \"Não informado\") & \"</p>\n                                <p><strong>Valor da Renda:</strong> \" & Coalesce(dadosEnsino.Valor_renda, \"Não informado\") & \"</p>\n                            </div>\n                        </div>\"\n                    },\n\n                    // --- SEÇÃO: VÍNCULOS ---\n                    \"Vínculos\", { part:\n                        \"<div class='section'>\n                            <h2>Vínculos Familiares e Comunitários</h2>\n                            <div class='content-box'>\n                                <h3>Composição do Grupo Familiar</h3>\n                                <p><strong>Quantidade de pessoas no grupo familiar:</strong> \" & Coalesce(Text(dadosVinculos.Qtd_Pessoas_Fam), \"Não informado\") & \"</p>\n                                <p><strong>Renda total (grupo de convivência):</strong> \" & If(!IsBlank(dadosVinculos.Renda_Total_Conv), \"R$ \" & Text(Value(dadosVinculos.Renda_Total_Conv), \"[$-pt-BR]#,##0.00\"), \"Não informado\") & \"</p>\n                            </div>\n                            \" & If(IsEmpty(listaFamiliares), \"<div class='content-box'><p>Nenhum membro do grupo familiar informado.</p></div>\",\n                                \"<div class='content-box'>\n                                    <h3>Detalhes dos Membros do Grupo Familiar:</h3>\n                                    <table class='report-table'>\n                                        <thead><tr><th>Nº</th><th>Grau de Parentesco/Vínculo Afetivo</th><th>Nome</th><th>Mora com a Vítima?</th><th>É Rede de Apoio?</th></tr></thead>\n                                        <tbody>\" & \n                                        \n                                        Concat(\n                                            ForAll(\n                                                Sequence(CountRows(listaFamiliares)) As seq, // Cria uma sequência: 1, 2, 3...\n                                                With(\n                                                    {\n                                                        familiar: Last(FirstN(listaFamiliares, seq.Value))\n                                                    },\n                                                    \n                                                    \"<tr>\n                                                        <td>\" & seq.Value & \"</td>\" &\n                                                        \"<td>\" & PlainText(familiar.AVF_Grau_Parentesco) & \"</td>\" &\n                                                        \"<td>\" & PlainText(familiar.AVF_Nome) & \"</td>\" &\n                                                        \"<td>\" & If(familiar.AVF_Mora_Com_Vitima, \"Sim\", \"Não\") & \"</td>\" &\n                                                        \"<td>\" & If(familiar.AVF_Rede_Apoio, \"Sim\", \"Não\") & \"</td>\n                                                    </tr>\"\n                                                )\n                                            ),\n                                            Value\n                                        ) & \n                                        \"</tbody>\n                                    </table>\n                                </div>\"\n                            ) & \"\n                        </div>\"\n                    },\n\n                    // --- SEÇÃO: SITUAÇÃO JURÍDICA ---\n                    \"Situação Jurídica\", { part:\n                        If(IsBlank(dadosJuridico1) And IsBlank(dadosJuridico2), \n                            \"<div class='section'><h2>Situação Jurídica</h2><div class='content-box'><p>Nenhuma informação jurídica cadastrada.</p></div></div>\",\n                            \"<div class='section'>\n                                <h2>Situação Jurídica</h2>\n                                <div class='content-box'>\n                                     <h3>Documentação Processual Principal</h3>\n                                     <p><strong>REDS:</strong> \" & Coalesce(dadosJuridico1.SJ_REDS, \"Não informado\") & \"</p>\n                                     <p><strong>IP - PCNet:</strong> \" & Coalesce(dadosJuridico1.SJ_IP_PCNet, \"Não informado\") & \"</p>\n                                     <p><strong>Auto Judicial (Principal):</strong> \" & Coalesce(dadosJuridico1.SJ_Auto_Judicial, \"Não informado\") & \"</p>\n                                     <p><strong>Nº do MPMG:</strong> \" & Coalesce(dadosJuridico1.SJ_Num_MPMG, \"Não informado\") & \"</p>\n                                </div>\n                                \" & If(!IsBlank(dadosJuridico2),\n                                    \"<div class='content-box'>\n                                        <h3>Demandas Jurídicas Relacionadas</h3>\n                                        <ul>\" &\n                                        If(dadosJuridico2.SJ2_Demanda_Info_Participacao, \"<li>Direito à informação e participação: \" & dadosJuridico2.SJ2_Demanda_Info_Participacao_Especif & If(dadosJuridico2.SJ2_Demanda_Info_Participacao_Especif = \"Outras formas de acesso à justiça\" And !IsBlank(dadosJuridico2.SJ2_Demanda_Info_Participacao_Especif2), \"; \" & dadosJuridico2.SJ2_Demanda_Info_Participacao_Especif2, \"\") & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Memoria_Verdade, \"<li>Direito à memória e verdade: \" & dadosJuridico2.SJ2_Demanda_Memoria_Verdade_Especif & If(dadosJuridico2.SJ2_Demanda_Memoria_Verdade_Especif = \"Outros\" And !IsBlank(dadosJuridico2.SJ2_Demanda_Memoria_Verdade_Especif2), \"; \" & dadosJuridico2.SJ2_Demanda_Memoria_Verdade_Especif2, \"\") & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Justica_Diligencia, \"<li>Direito à justiça e devida diligência: \" & dadosJuridico2.SJ2_Demanda_Justica_Diligencia_Especif & If(dadosJuridico2.SJ2_Demanda_Justica_Diligencia_Especif = \"Outras formas de acesso à justiça\" And !IsBlank(dadosJuridico2.SJ2_Demanda_Justica_Diligencia_Especif2), \"; \" & dadosJuridico2.SJ2_Demanda_Justica_Diligencia_Especif2, \"\") & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Apoio_Assistencia, \"<li>Direito à apoio e assistência: \" & dadosJuridico2.SJ2_Demanda_Apoio_Assistencia_Especif & If(dadosJuridico2.SJ2_Demanda_Apoio_Assistencia_Especif = \"Outros\" And !IsBlank(dadosJuridico2.SJ2_Demanda_Apoio_Assistencia_Especif2), \"; \" & dadosJuridico2.SJ2_Demanda_Apoio_Assistencia_Especif2, \"\") & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Seguranca, \"<li>Direito à segurança: \" & dadosJuridico2.SJ2_Demanda_Seguranca_Especif & If(dadosJuridico2.SJ2_Demanda_Seguranca_Especif = \"Outros\" And !IsBlank(dadosJuridico2.SJ2_Demanda_Seguranca_Especif2), \"; \" & dadosJuridico2.SJ2_Demanda_Seguranca_Especif2, \"\") & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Protecao_Nao_Revitimizacao, \"<li>Direito à proteção e não revitimização: \" & dadosJuridico2.SJ2_Demanda_Protecao_Nao_Revitimizacao_Especif & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Protecao_Psicologica, \"<li>Direito à proteção psicológica: \" & dadosJuridico2.SJ2_Demanda_Protecao_Psicologica_Especif & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Protecao_Documental, \"<li>Direito à proteção documental: \" & dadosJuridico2.SJ2_Demanda_Protecao_Documental_Especif & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Compensacao_Reparacao, \"<li>Direito à compensação e outras formas de reparação integral: \" & dadosJuridico2.SJ2_Demanda_Compensacao_Reparacao_Especif & \"</li>\", \"\") &\n                                        If(dadosJuridico2.SJ2_Demanda_Tratamento_Digno, \"<li>Direito à tratamento digno e respeitoso: \" & dadosJuridico2.SJ2_Demanda_Tratamento_Digno_Especif & \"</li>\", \"\") &\n                                        \"</ul>\n                                    </div>\",\n                                    \"\"\n                                ) & \"\n                            </div>\"\n                        )\n                    },\n\n                    // --- SEÇÃO: AGRESSOR ---\n                    \"Agressor\", { part:\n                        \"<div class='section'>\n                            <h2>Informações do(s) Agressor(es)</h2>\" &\n                            If(\n                                IsEmpty(agressoresComEnderecos),\n                                \"<div class='content-box'><p>Nenhum agressor cadastrado.</p></div>\",\n                                Concat(\n                                    agressoresComEnderecos As agressor,\n                                    With(\n                                        {\n                                            enderecos: agressor.enderecosAgressor\n                                        },\n                                        \"<div class='agressor-item'>\n                                            <h3>Agressor: \" & Coalesce(PlainText(agressor.PA_Nome_Civil),\"Não informado\") & \"</h3>\n                                            <p><strong>Tipo:</strong> \" & Coalesce(agressor.PA_Tipo_Agressor,\"Não informado\") & \"</p>\" &\n                                            If(\n                                                agressor.PA_Tipo_Agressor = \"Jurídica\",\n                                                \"<p><strong>Razão Social:</strong> \" & Coalesce(PlainText(agressor.PA_Razao_Social),\"Não informado\") & \"</p>\n                                                <p><strong>CNPJ:</strong> \" & Coalesce(agressor.PA_CNPJ,\"Não informado\") & \"</p>\",\n                                                \"<p><strong>Apelido:</strong> \" & Coalesce(PlainText(agressor.PA_Apelido),\"Não informado\") & \"</p>\n                                                <p><strong>Sexo:</strong> \" & Coalesce(agressor.PA_PPS_Sexo,\"Não informado\") & \"</p>\"\n                                            ) &\n                                            If(\n                                                IsEmpty(enderecos),\n                                                \"<div class='content-box'><p>Nenhum endereço cadastrado para este agressor.</p></div>\",\n                                                \"<div class='content-box'>\n                                                    <h4>Endereço(s) do agressor</h4>\n                                                    <table class='report-table-inner'>\n                                                        <thead>\n                                                            <tr>\n                                                                <th>Situação</th>\n                                                                <th>Endereço</th>\n                                                                <th>Número</th>\n                                                                <th>Complemento</th>\n                                                                <th>Bairro</th>\n                                                                <th>Cidade</th>\n                                                                <th>UF</th>\n                                                                <th>CEP</th>\n                                                            </tr>\n                                                        </thead>\n                                                        <tbody>\" &\n                                                        Concat(\n                                                            enderecos As endereco,\n                                                            \"<tr>\n                                                                <td>\" & Coalesce(endereco.PAE_Situacao_Moradia,\"Não informado\") & \"</td>\n                                                                <td>\" & Coalesce(PlainText(endereco.PAE_Endereco),\"Não informado\") & \"</td>\n                                                                <td>\" & Coalesce(endereco.PAE_Numero,\"S/N\") & \"</td>\n                                                                <td>\" & Coalesce(PlainText(endereco.PAE_Complemento),\"-\") & \"</td>\n                                                                <td>\" & Coalesce(PlainText(endereco.PAE_Bairro),\"Não informado\") & \"</td>\n                                                                <td>\" & Coalesce(PlainText(endereco.PAE_Cidade),\"Não informado\") & \"</td>\n                                                                <td>\" & Coalesce(endereco.PAE_UF,\"Não informado\") & \"</td>\n                                                                <td>\" & Coalesce(endereco.PAE_CEP,\"Não informado\") & \"</td>\n                                                            </tr>\"\n                                                        ) &\n                                                        \"</tbody>\n                                                    </table>\n                                                </div>\"\n                                            ) &\n                                        \"</div>\"\n                                    )\n                                )\n                            ) &\n                        \"</div>\"\n                    },\n\n                    // --- SEÇÃO: Acompanhamentos ---\n                    \"Acompanhamentos\", { part:\n                        \"<div class='section'>\n                            <h2>Acompanhamentos</h2>\n                            \" & \n                            If(\n                                IsEmpty(listaAcompanhamentos), \n                                \"<div class='content-box'><p>Nenhum acompanhamento registrado para este caso.</p></div>\",\n                                \n                                Concat(\n                                    Sort(listaAcompanhamentos, Criado, \"Ascending\"),\n                                    \n                                    \"<div class='acompanhamento-item'>\n                                        <h4>Acompanhamento de \" & Text(ThisRecord.Criado, \"dd/mm/yyyy - hh:mm\") & \"</h4>\n                                        <p><strong>Responsáveis:</strong> \" & \n                                        If(\n                                            IsEmpty(ThisRecord.Responsaveis),\n                                            \"Não informado\",\n                                            Concat(ThisRecord.Responsaveis, Value, \", \")\n                                        ) & \n                                        \"</p>\n                                        <p><strong>Tipo de atendimento:</strong> \" & Coalesce(ThisRecord.Tipo_Atendimento, \"Não informado\") & \"</p>\n                                        <p><strong>Síntese:</strong></p>\n                                        <div class='text-block'>\" & Coalesce(PlainText(ThisRecord.Sintese), \"Nenhuma síntese registrada.\") & \"</div>\n                                        <p><strong>Encaminhamento Rede:</strong> \" & Coalesce(ThisRecord.Encaminhamento_Rede, \"Não informado\") & \"</p>\" &\n                                        If(\n                                            !IsBlank(ThisRecord.Especifique_Encaminhamento), \n                                            \"<p><strong>Especificação do Encaminhamento:</strong> \" & Coalesce(ThisRecord.Especifique_Encaminhamento, \"Não informada\") & \"</p>\",\n                                            \"\"\n                                        ) &\n                                        \"<p><strong>Encaminhamento:</strong></p>\n                                        <div class='text-block'>\" & Coalesce(PlainText(ThisRecord.Encaminhamento), \"Nenhum encaminhamento registrado.\") & \"</div>\n                                    </div>\"\n                                )\n                            ) & \"\n                        </div>\"\n                    },\n                    /*\n                    // --- SEÇÃO: Acompanhamentos ---\n                    \"Acompanhamentos\"; { part:\n                        \"<div class='section'>\n                            <h2>Acompanhamentos</h2>\n                            \" & \n                            If(\n                                IsBlank(dadosAcompanhamentos); \n                                \"<div class='content-box'><p>Dados sobre acompanhamentos ainda não foram preenchidos.</p></div>\";\n                                \"<div class='content-box'>\n                                    <p><strong>Responsáveis:</strong> \" & \n                                    If(\n                                        IsEmpty(dadosAcompanhamentos.Responsaveis);\n                                        \"Não informado\";\n                                        Concat(dadosAcompanhamentos.Responsaveis; Value; \", \")\n                                    ) & \n                                    \"</p>\n                                    <p><strong>Tipo de atendimento:</strong> \" & Coalesce(dadosAcompanhamentos.Tipo_Atendimento; \"Não informado\") & \"</p>\n                                    <p><strong>Síntese:</strong></p>\n                                    <div class='text-block'>\" & Coalesce(PlainText(dadosAcompanhamentos.Sintese); \"Nenhuma observação registrada.\") & \"</div>\n                                    <p><strong>Encaminhamento Rede:</strong> \" & Coalesce(dadosAcompanhamentos.Encaminhamento_Rede; \"Não informado\") & \"</p>\" &\n                                    If(\n                                        !IsBlank(dadosAcompanhamentos.Encaminhamento_Rede); \n                                        \"<p><strong>Encaminhamento Rede Especificação:</strong> \" & Coalesce(dadosAcompanhamentos.Especifique_Encaminhamento; \"Não informada\") & \"</p>\";\n                                        \"\"\n                                    ) &\n                                    \"<p><strong>Encaminhamento:</strong></p>\n                                    <div class='text-block'>\" & Coalesce(PlainText(dadosAcompanhamentos.Encaminhamento); \"Nenhuma observação registrada.\") & \"</div>\n                                    <p><strong>Modificado em:</strong> \" & Coalesce(Text(dadosAcompanhamentos.Modificado; \"dd/mm/yyyy\"); \"Não informado\") & \"</p>\n                                </div>\"\n                            ) & \"\n                        </div>\"\n                    };*/\n                    \n\n                    // --- SEÇÃO: ENCERRAMENTO ---\n                    \"Encerramento\", { part:\n                        \"<div class='section'>\n                            <h2>Encerramento do Caso</h2>\n                            \" & If(IsBlank(dadosEncerramento), \"<div class='content-box'><p>Dados sobre o encerramento ainda não foram preenchidos.</p></div>\",\n                                \"<div class='content-box'>\n                                    <p><strong>Data do Encerramento:</strong> \" & Coalesce(Text(dadosEncerramento.Data, \"dd/mm/yyyy\"), \"Não informada\") & \"</p>\n                                    <p><strong>Forma de Encerramento:</strong> \" & Coalesce(dadosEncerramento.Forma_Encerramento_Caso, \"Não informada\") & \"</p>\n                                    \" & If(dadosEncerramento.Forma_Encerramento_Caso = \"Outros\", \"<p><strong>Especifique:</strong></p><div class='text-block'>\" & PlainText(dadosEncerramento.Especifique_Outros) & \"</div>\", \"\") & \"\n                                    <p><strong>Observações:</strong></p>\n                                    <div class='text-block'>\" & Coalesce(PlainText(dadosEncerramento.Observacao), \"Nenhuma observação registrada.\") & \"</div>\n                                </div>\"\n                            ) & \"\n                        </div>\"\n                    }\n                )\n            )\n        )\n    );\n\n    // --- ETAPA FINAL: JUNTAR TUDO, GERAR PDF E ABRIR ---\n    Collect(htmlParts, {part: \"</body></html>\"});\n    Set(_htmlGerado, Concat(htmlParts, part));\n    Set(_varLink, Substitute(HTML_para_PDF.Run(_htmlGerado, \"Relatório PAV-SAVe - Caso \" & ItemAtual.ID_Caso).linkdownload, \"_mpmg_mp_br/\", \"_mpmg_mp_br/_layouts/download.aspx/\"));\n    Launch(Mid(_varLink, 12, Len(_varLink) - 13));\n    Set(_Carregando, false);\n)\n"
                  Text: ="Gerar PDF"
                  Width: =200
      - MenuPassos_19:
          Control: CanvasComponent
          ComponentName: MenuPassos
          Properties:
            GaleriaAbas: "=With(\r\n    {\r\n        menu: If(_FormCompleto, \r\n        [\r\n            {\r\n                idMenu: 1,\r\n                largura: 120,\r\n                nome: \"Dados de Entrada\",\r\n                descricao: \"\",\r\n                pagina: Tela_Dados_Entrada\r\n            },\r\n            {\r\n                idMenu: 2,\r\n                largura: 120,//150\r\n                nome: \"Sócio identificação\",\r\n                descricao: \"\",\r\n                pagina: Tela_Socio_Identificacao\r\n            },\r\n            {\r\n                idMenu: 3,\r\n                largura: 120,//180\r\n                nome: \"Ensino - trab - renda\",\r\n                descricao: \"\",\r\n                pagina: Tela_Ensino_Trab_Renda\r\n            },\r\n            \r\n            {\r\n                idMenu: 4,\r\n                largura: 60,\r\n                nome: \"Assistência\",\r\n                descricao: \"\",\r\n                pagina: Tela_Assistencia\r\n            },\r\n            {\r\n                idMenu: 5,\r\n                largura: 90,\r\n                nome: \"Território\",\r\n                descricao: \"\",\r\n                pagina: Tela_Territorio\r\n            },\r\n            {\r\n                idMenu: 6,\r\n                largura: 80,\r\n                nome: \"Saúde\",\r\n                descricao: \"\",\r\n                pagina: Tela_Saude\r\n            },\r\n            {\r\n                idMenu: 7,\r\n                largura: 85,\r\n                nome: \"Vínculos\",\r\n                descricao: \"\",\r\n                pagina: Tela_Vinculos\r\n            },\r\n            {\r\n                idMenu: 8,\r\n                largura: 120,//200\r\n                nome: \"Situação Jurídica\",\r\n                descricao: \"\",\r\n                pagina: Tela_SitJuridica\r\n            },\r\n            {\r\n                idMenu: 9,\r\n                largura: 110,\r\n                nome: \"Agressor\",\r\n                descricao: \"\",\r\n                pagina: Tela_Agressor\r\n            },\r\n            {\r\n                idMenu: 10,\r\n                largura: 120,//180\r\n                nome: \"Proteção-segurança\",\r\n                descricao: \"\",\r\n                pagina: Tela_Protecao_Seguranca\r\n            },\r\n            {\r\n                idMenu: 11,\r\n                largura: 120,\r\n                nome: \"Vitimização secundária e terciária\",\r\n                descricao: \"\",\r\n                pagina: Tela_Vitimizacao\r\n            },\r\n            /*{\r\n                idMenu: 12;\r\n                largura: 120;//132\r\n                nome: \"Matriz de risco\";\r\n                descricao: \"\";\r\n                pagina: Tela_Matriz_De_Risco\r\n            };*/\r\n            {\r\n                idMenu: 12,\r\n                largura: 120,\r\n                nome: \"Síntese Analítica\",\r\n                descricao: \"\",\r\n                pagina: Tela_Sintese_Analitica\r\n            },\r\n            {\r\n                idMenu: 13,\r\n                largura: 120,//170\r\n                nome: \"Acompanhamentos\",\r\n                descricao: \"\",\r\n                pagina: Tela_Acompanhamento\r\n            },\r\n            /*{\r\n                idMenu: 14;\r\n                largura: 120;//200\r\n                nome: \"Relato de Atendimento\";\r\n                descricao: \"\";\r\n                pagina: Tela_Relato_De_Atendimento\r\n            };*/\r\n            {\r\n                idMenu: 14,\r\n                largura: 120,//135\r\n                nome: \"Encerramento\",\r\n                descricao: \"\",\r\n                pagina: Tela_Encerramento\r\n            },\r\n            {\r\n                idMenu: 15,\r\n                largura: 120,//135\r\n                nome: \"Referências\",\r\n                descricao: \"\",\r\n                pagina: Tela_Referencias\r\n            },\r\n            {\r\n                idMenu: 16,\r\n                largura: 120,//135\r\n                nome: \"Relatório\",\r\n                descricao: \"\",\r\n                pagina: Tela_Relatorio\r\n            }\r\n        ], //dados de entrada, socioidentificação, situação juridica maior e menor, proteção-segurança e vitimização \r\n        [\r\n            {\r\n                idMenu: 1,\r\n                largura: 170,\r\n                nome: \"Dados de Entrada\",\r\n                descricao: \"\",\r\n                pagina: Tela_Dados_Entrada\r\n            },\r\n            {\r\n                idMenu: 2,\r\n                largura: 150,\r\n                nome: \"Sócio identificação\",\r\n                descricao: \"\",\r\n                pagina: Tela_Socio_Identificacao\r\n            },\r\n            {\r\n                idMenu: 3,\r\n                largura: 200,\r\n                nome: \"Situação Jurídica\",\r\n                descricao: \"\",\r\n                pagina: Tela_SitJuridica\r\n            },\r\n            {\r\n                idMenu: 4,\r\n                largura: 180,\r\n                nome: \"Proteção-segurança\",\r\n                descricao: \"\",\r\n                pagina: Tela_Protecao_Seguranca\r\n            },\r\n            {\r\n                idMenu: 5,\r\n                largura: 240,\r\n                nome: \"Vitimização secundária e terciária\",\r\n                descricao: \"\",\r\n                pagina: Tela_Vitimizacao\r\n            },\r\n            {\r\n                idMenu: 6,\r\n                largura: 120,//135\r\n                nome: \"Relatório\",\r\n                descricao: \"\",\r\n                pagina: Tela_Relatorio\r\n            }\r\n        ]\r\n        )\r\n    },\r\n    With(\r\n        {\r\n            // Acrescenta a coluna \"larguraCalc\" conforme regra:\r\n            // Se o item for o selecionado (_passoAtual.idMenu), usa a largura definida;\r\n// Senão, divide o espaço restante igualmente entre os demais itens.\r\nmenuCalc: AddColumns(\r\n                menu,\r\n                larguraCalc,\r\n                If(\r\n                    pagina = MenuPassos_1.TelaAtual,\r\n                    largura,\r\n                    If(pagina = Tela_Vitimizacao, largura,\r\n                    ((Self.Width - 100) - LookUp(\r\n                        menu,\r\n                        pagina = MenuPassos_1.TelaAtual,\r\n                        largura\r\n                    )) / (CountRows(menu) - 1))\r\n                )\r\n            )\r\n        },\r\n        // Ordena os itens pelo idMenu e calcula a posição \"distancia\" de cada item\r\n// somando as larguras calculadas dos itens anteriores.\r\n        AddColumns(\r\n            SortByColumns(\r\n                menuCalc,\r\n                \"idMenu\",\r\n                SortOrder.Ascending\r\n            ) As m1,\r\n            distancia,\r\n            Sum(\r\n                Filter(\r\n                    menuCalc,\r\n                    idMenu < m1.idMenu\r\n                ),\r\n                larguraCalc\r\n            )\r\n        )\r\n    )\r\n)"
            Height: =100
            TelaAtual: =App.ActiveScreen
            Width: =App.Width
            Y: =MenuSuperior_24.Y + MenuSuperior_24.Height + 10
      - MenuSuperior_24:
          Control: CanvasComponent
          ComponentName: MenuSuperior
          Properties:
            Height: =60
            Width: =1346
            X: =10
            Y: =10
      - ButtonCanvas1:
          Control: Button@0.0.45
          Properties:
            Appearance: ='ButtonCanvas.Appearance'.Transparent
            BasePaletteColor: =cor.tema
            Icon: ="Eraser"
            IconStyle: ='ButtonCanvas.IconStyle'.Outline
            Layout: ='ButtonCanvas.Layout'.IconOnly
            OnSelect: =Reset(SeletorDadosGerarRelatorio)
            Visible: =!IsEmpty(SeletorDadosGerarRelatorio.SelectedItems)
            Width: =32
            X: =SeletorDadosGerarRelatorio.X - Self.Width
            Y: =260
      - Carregamento_3:
          Control: CanvasComponent
          ComponentName: Carregamento
          Properties:
            Height: =Container22.Height
            Texto_Carregamento: ="Gerando PDF..."
            Visible: =_Carregando
            Width: =Container22.Width
            X: =Container22.X
            Y: =Container22.Y
            cor_tema: =cor.tema
